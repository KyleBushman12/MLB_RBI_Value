---
title: "Expected_RBI"
author: "Kyle Bushman"
date: "2025-07-31"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(baseballr)
library(tidyverse)
library(readxl)
library(rvest)
library(mlbplotR)
```

```{r, include=FALSE}
data_2023 <- read.csv("~/Downloads/Baseball/Baseball2023/All_Plays_2023.csv")
data_2024 <- read.csv("~/Downloads/Baseball/Baseball2024/All_Plays_2024.csv")
data_2025 <- read.csv("~/Downloads/Baseball/Baseball2025/All_Plays_2025.csv")

key <- read_xlsx("~/Downloads/Baseball/team_name_key.xlsx")

color_key <- key |>
  select(Team, Color)

name_key <- key |>
  select(TeamName, Team)
```

```{r}
data_2024 <- data_2024 |>
  select(game_date, game_year, player_name, batter, events, description,
         on_3b, on_2b, on_1b, outs_when_up,
         bat_score, post_bat_score, home_team, away_team, inning_topbot) |>
  filter(events != "") |>
  mutate(RBI = post_bat_score - bat_score)

data_2023 <- data_2023 |>
  select(game_date, game_year, player_name, batter, events, description,
         on_3b, on_2b, on_1b, outs_when_up,
         bat_score, post_bat_score, home_team, away_team, inning_topbot) |>
  filter(events != "") |>
  mutate(RBI = post_bat_score - bat_score)

data <- rbind(data_2023, data_2024)

data$bat_team <- ifelse(data$inning_topbot == "Top",
                        data$away_team, data$home_team)

data <- data |>
  select(game_date, game_year, player_name, batter, events, description,
         on_3b, on_2b, on_1b, outs_when_up,
         bat_score, post_bat_score, bat_team, RBI)

data$on_3b <- ifelse(is.na(data$on_3b),
                     0,1)
data$on_2b <- ifelse(is.na(data$on_2b),
                     0,1)
data$on_1b <- ifelse(is.na(data$on_1b),
                     0,1)

data$sit <- paste(data$outs_when_up, data$on_1b, data$on_2b, data$on_3b,
                  sep = "")

data$sit <- as.factor(data$sit)

RBI <- data |>
  group_by(sit) |>
  summarise(xRBI = mean(RBI))

data <- left_join(data, RBI, by = "sit")
```

```{r, echo = FALSE}
data$runners <- paste(data$on_1b, data$on_2b, data$on_3b,
                  sep = "")

data$runners <- as.factor(data$runners)

data$outs_when_up <- as.factor(data$outs_when_up)

data$xRBI <- round(data$xRBI, 2)

data$vRBI <- data$RBI - data$xRBI

ggplot(data, aes(x = runners, y = xRBI, fill = outs_when_up, label = xRBI)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  geom_text(position = position_dodge(width = 0.9),
            vjust = -0.5,
            size = 2,
            color = "black",
            aes(group = outs_when_up))+
  labs(title="RBI Expectancy by Scenario", x="Baserunners", y="Expected RBIs",
       fill = "Outs")
```

```{r, echo = FALSE}
pRBI <- data |>
  group_by(player_name, game_year, batter) |>
  summarise(vRBI = sum(vRBI), xRBI = sum(xRBI), tRBI = sum(RBI)) |>
  arrange(desc(xRBI)) |>
  filter(tRBI > 25)

pRBI$RBI_ratio <- pRBI$tRBI/pRBI$xRBI
```

```{r, echo = FALSE}
ggplot(pRBI, aes(x = xRBI, y = vRBI)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Expected RBI Vs. RBI Value")
```

```{r, echo = FALSE}
ggplot(pRBI, aes(x = tRBI, y = vRBI)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Total RBI Vs. RBI Value")
```

```{r, echo = FALSE}
ggplot(pRBI, aes(x = xRBI, y = tRBI)) +
  geom_point() +
  geom_smooth() +
  labs(title = "Expected RBI Vs. Total RBI")
```

```{r, echo = FALSE}
# Get final team for each player based on last row (latest game_date)
final_teams <- data |>
  arrange(game_date) |>
  group_by(player_name, game_year) |>
  slice_tail(n = 1) |>
  ungroup() |>
  select(player_name, game_year, final_team = bat_team)

# 2. Aggregate season totals per player (do not split by team)
Team_RBI <- data |>
  group_by(player_name, game_year, batter) |>
  summarise(
    vRBI = sum(vRBI),
    xRBI = sum(xRBI),
    tRBI = sum(RBI),
    .groups = "drop"
  )

# 3. Join final team info
Team_RBI <- Team_RBI |>
  left_join(final_teams, by = c("player_name", "game_year"))

# 4. Join team colors/logos (if you need for plots)
Team_RBI <- Team_RBI |>
  left_join(color_key, by = c("final_team" = "Team"))

# 5. Optional: add player rank (e.g., by xRBI)
Team_RBI <- Team_RBI |>
  arrange(desc(xRBI)) |>
  mutate(Rank = row_number())
```

```{r, echo = FALSE}
RBI_2023 <- Team_RBI |>
  ungroup() |>
  filter(game_year == 2023) |>
  arrange(desc(vRBI)) |>
  mutate(Rank = dense_rank(desc(vRBI))) |>
  filter(tRBI > 25) |>
  mutate(RBI_ratio = tRBI/xRBI)

RBI_2023_10 <- RBI_2023 |>
  filter(Rank < 11)

ggplot(RBI_2023_10, aes(x = reorder(player_name, -vRBI), y = vRBI, fill = Color)) +
  geom_bar(stat = "identity") +  
  labs(title = "vRBI Leaders 2023", x = "Player", y = "vRBI") +
  scale_fill_identity() +  
  geom_mlb_headshots(aes(player_id = batter), width = 0.1)+
  theme(axis.text.x = element_blank())+
  geom_text(aes(label = player_name), vjust = 8, hjust = 0.5,
            size = 1.5, color="white")
```

```{r, echo = FALSE}
RBI_2024 <- Team_RBI |>
  ungroup() |>
  filter(game_year == 2024) |>
  arrange(desc(vRBI)) |>
  mutate(Rank = dense_rank(desc(vRBI))) |>
  filter(tRBI > 25) |>
  mutate(RBI_ratio = tRBI/xRBI)

RBI_2024_10 <- RBI_2024 |>
  filter(Rank < 11)

ggplot(RBI_2024_10, aes(x = reorder(player_name, -vRBI), y = vRBI, fill = Color)) +
  geom_bar(stat = "identity") +  
  labs(title = "vRBI Leaders 2024", x = "Player", y = "vRBI") +
  scale_fill_identity() +  
  geom_mlb_headshots(aes(player_id = batter), width = 0.1)+
  theme(axis.text.x = element_blank())+
  geom_text(aes(label = player_name), vjust = 8, hjust = 0.5,
            size = 1.5, color="white")
```

```{r, echo = FALSE, message = FALSE}
data_2025 <- data_2025 |>
  select(game_year, player_name, batter, events, description,
         on_3b, on_2b, on_1b, outs_when_up,
         bat_score, post_bat_score, home_team, away_team, inning_topbot) |>
  filter(events != "") |>
  mutate(RBI = post_bat_score - bat_score)

data_2025$bat_team <- ifelse(data_2025$inning_topbot == "Top",
                             data_2025$away_team, data_2025$home_team)

data_2025 <- data_2025 |>
  select(game_year, player_name, batter, events, description,
         on_3b, on_2b, on_1b, outs_when_up,
         bat_score, post_bat_score, bat_team, RBI)

data_2025$on_3b <- ifelse(is.na(data_2025$on_3b),
                     0,1)
data_2025$on_2b <- ifelse(is.na(data_2025$on_2b),
                     0,1)
data_2025$on_1b <- ifelse(is.na(data_2025$on_1b),
                     0,1)

data_2025$sit <- paste(data_2025$outs_when_up,
                       data_2025$on_1b, data_2025$on_2b, data_2025$on_3b,
                       sep = "")

data_2025$sit <- as.factor(data_2025$sit)

RBI <- data_2025 |>
  group_by(sit) |>
  summarise(xRBI = mean(RBI))

data_2025 <- left_join(data_2025, RBI, by = "sit")

data_2025$runners <- paste(data_2025$on_1b, data_2025$on_2b, data_2025$on_3b,
                  sep = "")

data_2025$runners <- as.factor(data_2025$runners)

data_2025$outs_when_up <- as.factor(data_2025$outs_when_up)

data_2025$xRBI <- round(data_2025$xRBI, 2)

data_2025$vRBI <- data_2025$RBI - data_2025$xRBI

pRBI_2025 <- data_2025 |>
  group_by(player_name, game_year, batter) |>
  summarise(vRBI = sum(vRBI), xRBI = sum(xRBI), tRBI = sum(RBI)) |>
  arrange(desc(xRBI)) |>
  filter(tRBI > 25)

pRBI_2025$RBI_ratio <- pRBI_2025$tRBI/pRBI_2025$xRBI
```

```{r, echo = FALSE, message = FALSE}
Team_RBI_2025 <- data_2025 |>
  group_by(player_name, game_year, batter, bat_team) |>
  summarise(vRBI = sum(vRBI), xRBI = sum(xRBI), tRBI = sum(RBI)) |>
  arrange(desc(xRBI)) |>
  filter(tRBI > 25)

Team_RBI_2025 <- left_join(Team_RBI_2025, color_key, by = c("bat_team" = "Team"))

RBI_2025 <- Team_RBI_2025 |>
  ungroup() |>
  filter(game_year == 2025) |>
  arrange(desc(vRBI)) |>
  mutate(Rank = dense_rank(desc(vRBI))) |>
  filter(tRBI > 25) |>
  mutate(RBI_ratio = tRBI/xRBI)

RBI_2025_10 <- RBI_2025 |>
  filter(Rank < 11)

ggplot(RBI_2025_10, aes(x = reorder(player_name, -vRBI), y = vRBI, fill = Color)) +
  geom_bar(stat = "identity") +  
  labs(title = "vRBI Leaders 2025", x = "Player", y = "vRBI") +
  scale_fill_identity() +  
  geom_mlb_headshots(aes(player_id = batter), width = 0.1)+
  theme(axis.text.x = element_blank())+
  geom_text(aes(label = player_name), vjust = 8, hjust = 0.5,
            size = 1.5, color="white")
```

```{r, echo = FALSE, message = FALSE}
Team_total_RBI <- data |>
  group_by(bat_team, game_year) |>
  summarise(vRBI = sum(vRBI), xRBI = sum(xRBI), tRBI = sum(RBI)) |>
  arrange(desc(xRBI))
```

```{r}
Current_team_RBI <- data_2025 |>
  group_by(bat_team) |>
  summarise(vRBI = sum(vRBI), xRBI = sum(xRBI), tRBI = sum(RBI))

url <- "https://www.baseball-reference.com/leagues/majors/2025-standard-pitching.shtml"

# Read the HTML content of the webpage
win_2025 <- read_html(url)

# Extract the first table from the webpage
win_2025 <- data.frame(html_table(html_nodes(win_2025, "table")[1], fill = TRUE))

win_2025 <- win_2025[-c(31:33),]

win_2025 <- win_2025 |>
  select(Tm, W, G)

win_2025 <- left_join(win_2025, name_key, by = c("Tm" = "TeamName"))

win_2025 <- win_2025 |>
  select(Team, W, G)

win_2025$W <- as.numeric(win_2025$W)/as.numeric(win_2025$G)

Current_team_RBI <- left_join(Current_team_RBI, win_2025, by = c("bat_team" = "Team"))

url <- "https://www.baseball-reference.com/leagues/majors/2025-standard-batting.shtml"

# Read the HTML content of the webpage
bat_2025 <- read_html(url)

# Extract the first table from the webpage
bat_2025 <- data.frame(html_table(html_nodes(bat_2025, "table")[1], fill = TRUE))

bat_2025 <- bat_2025[-c(31:33),]

bat_2025 <- bat_2025 |>
  select(Tm, BA, OBP, SLG, OPS)

bat_2025 <- left_join(bat_2025, name_key, by = c("Tm" = "TeamName"))

bat_2025 <- bat_2025 |>
  select(Team, BA, OBP, SLG, OPS)

Current_team_RBI <- left_join(Current_team_RBI, bat_2025, by = c("bat_team" = "Team"))

Current_team_RBI$bat_team <- ifelse(Current_team_RBI$bat_team == "ATH",
                                    "OAK", Current_team_RBI$bat_team)

Current_team_RBI$OPS <- as.numeric(Current_team_RBI$OPS)
Current_team_RBI$SLG <- as.numeric(Current_team_RBI$SLG)
Current_team_RBI$OBP <- as.numeric(Current_team_RBI$OBP)
Current_team_RBI$BA <- as.numeric(Current_team_RBI$BA)

cor(Current_team_RBI$vRBI, Current_team_RBI$BA)
cor(Current_team_RBI$vRBI, Current_team_RBI$OBP)
cor(Current_team_RBI$vRBI, Current_team_RBI$SLG)
cor(Current_team_RBI$vRBI, Current_team_RBI$OPS)
```

```{r, echo = FALSE}
ggplot(Current_team_RBI, aes(x = vRBI, y = W)) +
  geom_hline(yintercept = 0.5, linetype = "dashed", color = "gray") +
  geom_vline(xintercept = 0, linetype = "dashed", color = "gray") +
  geom_mlb_logos(aes(team_abbr = bat_team), width = 0.05) +
  labs(title = "RBI Value Vs. Win%", x = "vRBI", y = "Win%")
```

```{r, echo = FALSE}
ggplot(Current_team_RBI, aes(x = OPS, y = vRBI)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_smooth(method = "lm", color = "gray") +
  geom_mlb_logos(aes(team_abbr = bat_team), width = 0.05) +
  labs(title = "OPS Vs. RBI Value", x = "OPS", y = "vRBI")
```

```{r, echo = FALSE}
ggplot(Current_team_RBI, aes(x = SLG, y = vRBI)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_smooth(method = "lm", color = "gray") +
  geom_mlb_logos(aes(team_abbr = bat_team), width = 0.05) +
  labs(title = "SLG Vs. RBI Value", x = "SLG", y = "vRBI")
```

```{r, echo = FALSE}
ggplot(Current_team_RBI, aes(x = OBP, y = vRBI)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_smooth(method = "lm", color = "gray") +
  geom_mlb_logos(aes(team_abbr = bat_team), width = 0.05) +
  labs(title = "OBP Vs. RBI Value", x = "OBP", y = "vRBI")
```

```{r, echo = FALSE}
ggplot(Current_team_RBI, aes(x = BA, y = vRBI)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  geom_smooth(method = "lm", color = "gray") +
  geom_mlb_logos(aes(team_abbr = bat_team), width = 0.05) +
  labs(title = "BA Vs. RBI Value", x = "BA", y = "vRBI")
```